<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sleep Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f6f8;
    }
    .chart-container {
      margin-bottom: 40px;
      padding: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    h2 {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>ðŸ“Š Sleep Dashboard</h1>

  <div class="chart-container">
    <h2>Total Sleep Hours</h2>
    <div id="totalSleep"></div>
  </div>

  <div class="chart-container">
    <h2>Sleep Stages Breakdown</h2>
    <div id="sleepStages"></div>
  </div>

  <div class="chart-container">
    <h2>Average SPOâ‚‚</h2>
    <div id="spo2Chart"></div>
  </div>

  <div class="chart-container">
    <h2>Average Heart Rate</h2>
    <div id="hrChart"></div>
  </div>

  <div class="chart-container">
    <h2>Sleep Score</h2>
    <div id="scoreChart"></div>
  </div>

  <script>
    fetch("sleep_data.csv")
      .then(response => response.text())
      .then(csvText => {
        const data = Papa.parse(csvText, { header: true, dynamicTyping: true }).data;

        // Clean empty rows (PapaParse often adds an extra at the end)
        const cleanData = data.filter(d => d.calendarDate);

        // Convert seconds â†’ hours and extract extra metrics
        cleanData.forEach(d => {
          d.totalSleepHours = (d.deepSleepSeconds + d.lightSleepSeconds + d.remSleepSeconds) / 3600;
          d.deepSleepHours = d.deepSleepSeconds / 3600;
          d.lightSleepHours = d.lightSleepSeconds / 3600;
          d.remSleepHours = d.remSleepSeconds / 3600;
          d.awakeSleepHours = d.awakeSleepSeconds / 3600;
          d.averageSPO2 = d.spo2SleepSummary_averageSPO2;
          d.averageHR = d.spo2SleepSummary_averageHR;
          d.sleepScore = d.sleepScores_overallScore;
        });

        // === Total Sleep Hours ===
        Plotly.newPlot("totalSleep", [{
          x: cleanData.map(d => d.calendarDate),
          y: cleanData.map(d => d.totalSleepHours),
          type: "scatter",
          mode: "lines+markers",
          name: "Total Sleep",
          line: { shape: "spline", color: "#2E86AB", width: 3 },
          marker: { size: 8, color: "#1f77b4" },
          hovertemplate: '%{y:.2f} hours<br>Date: %{x}<extra></extra>'
        }], {
          title: "ðŸ’¤ Total Sleep Hours",
          yaxis: { title: "Hours" },
          xaxis: { title: "Date", tickangle: -45 }
        });

        // === Sleep Stages Breakdown ===
        let stages = [
          { key: "deepSleepHours", label: "Deep Sleep", color: "#003f5c" },
          { key: "lightSleepHours", label: "Light Sleep", color: "#7a5195" },
          { key: "remSleepHours", label: "REM Sleep", color: "#ef5675" },
          { key: "awakeSleepHours", label: "Awake", color: "#ffa600" }
        ];

        let traces = stages.map(stage => ({
          x: cleanData.map(d => d.calendarDate),
          y: cleanData.map(d => d[stage.key]),
          type: "bar",
          name: stage.label,
          marker: { color: stage.color },
          hovertemplate: '%{y:.2f} hours<br>Date: %{x}<extra></extra>'
        }));

        Plotly.newPlot("sleepStages", traces, {
          barmode: "stack",
          title: "Sleep Stage Breakdown",
          yaxis: { title: "Hours" },
          xaxis: { title: "Date", tickangle: -45 }
        });

        // === Average SPO2 ===
        Plotly.newPlot("spo2Chart", [{
          x: cleanData.map(d => d.calendarDate),
          y: cleanData.map(d => d.averageSPO2),
          type: "scatter",
          mode: "lines+markers",
          line: { color: "#ff5733", width: 3 },
          hovertemplate: '%{y:.1f}% SPOâ‚‚<br>Date: %{x}<extra></extra>'
        }], {
          title: "Average SPOâ‚‚ during Sleep",
          yaxis: { title: "SPOâ‚‚ (%)", range: [85, 100] },
          xaxis: { title: "Date", tickangle: -45 }
        });

        // === Average HR ===
        Plotly.newPlot("hrChart", [{
          x: cleanData.map(d => d.calendarDate),
          y: cleanData.map(d => d.averageHR),
          type: "scatter",
          mode: "lines+markers",
          line: { color: "#d62728", width: 3 },
          hovertemplate: '%{y} bpm<br>Date: %{x}<extra></extra>'
        }], {
          title: "Average Heart Rate during Sleep",
          yaxis: { title: "BPM" },
          xaxis: { title: "Date", tickangle: -45 }
        });

        // === Sleep Score ===
        Plotly.newPlot("scoreChart", [{
          x: cleanData.map(d => d.calendarDate),
          y: cleanData.map(d => d.sleepScore),
          type: "bar",
          marker: { color: "#17becf" },
          hovertemplate: 'Score: %{y}<br>Date: %{x}<extra></extra>'
        }], {
          title: "Sleep Scores",
          yaxis: { title: "Score (0-100)", range: [0, 100] },
          xaxis: { title: "Date", tickangle: -45 }
        });

      });
  </script>
</body>
</html>
