<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sleep Stages Breakdown</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background: #f4f6f8;
      color: #333;
    }
    .chart-container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
    }
  </style>
</head>
<body>
  <h1>ðŸŒ™ Sleep Stages Breakdown by Night</h1>

  <div class="chart-container">
    <div id="sleepStages"></div>
  </div>

  <script>
    fetch("sleep_data.csv")
      .then(response => {
        if (!response.ok) {
          throw new Error("CSV file not found. Make sure sleep_data.csv is in the same folder.");
        }
        return response.text();
      })
      .then(csvText => {
        const data = Papa.parse(csvText, { header: true, dynamicTyping: true }).data;

        // Clean empty rows
        const cleanData = data.filter(d => d.calendarDate);

        console.log("Loaded rows:", cleanData.length); // âœ… Debugging

        if (cleanData.length === 0) {
          document.getElementById("sleepStages").innerHTML = "<p style='color:red'>No data found in CSV</p>";
          return;
        }

        // Convert to hours
        cleanData.forEach(d => {
          d.deepSleepHours = (d.deepSleepSeconds || 0) / 3600;
          d.lightSleepHours = (d.lightSleepSeconds || 0) / 3600;
          d.remSleepHours   = (d.remSleepSeconds   || 0) / 3600;
          d.awakeSleepHours = (d.awakeSleepSeconds || 0) / 3600;
        });

        // Define stages
        const stages = [
          { key: "deepSleepHours", label: "Deep Sleep", color: "#003f5c" },
          { key: "lightSleepHours", label: "Light Sleep", color: "#7a5195" },
          { key: "remSleepHours",   label: "REM Sleep",  color: "#ef5675" },
          { key: "awakeSleepHours", label: "Awake",      color: "#ffa600" }
        ];

        // Build traces
        let traces = stages.map(stage => ({
          x: cleanData.map(d => d.calendarDate),
          y: cleanData.map(d => d[stage.key]),
          type: "bar",
          name: stage.label,
          marker: { color: stage.color },
          hovertemplate: '%{y:.2f} hours<br>Date: %{x}<extra></extra>'
        }));

        // Plot
        Plotly.newPlot("sleepStages", traces, {
          barmode: "stack",
          title: { text: "Sleep Stage Breakdown", font: { size: 22 } },
          xaxis: { title: "Date", tickangle: -45, type: "date", tickfont: { size: 12 } },
          yaxis: { title: "Hours", gridcolor: "#eaeaea" },
          legend: { title: { text: "Stage" }, orientation: "h", y: -0.25 },
          margin: { l: 60, r: 30, t: 60, b: 100 },
          plot_bgcolor: "white",
          hovermode: "x unified"
        });
      })
      .catch(error => {
        console.error("Error loading CSV:", error);
        document.getElementById("sleepStages").innerHTML = "<p style='color:red'>Error loading CSV file</p>";
      });
  </script>
</body>
</html>
